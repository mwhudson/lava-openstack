metadata:
   name: tempest
   maintainer:
      - Michael Hudson-Doyle <michael.hudson@linaro.org>
   format: "Lava-Test-Shell Test Definition 1.0"
   version: 1.0
   description: ""
   os:
      - ubuntu
   devices:
      - mustang
   environment:
      - lava-test-shell

run:
  steps:
    - "resolvconf -u"
    - "set -x"
    - "export LAVA_RUN_TEMPEST LAVA_TESTS_TO_RUN"
    - "sudo -u ubuntu -E ~/run-in-tempest-dir.sh ./tempest.sh"
    - "tar -xvzf ~ubuntu/output.tgz"
    - "cd output"
    - 'for i in *; do lava-test-run-attach "$i"; done'
    - "python ../simplify-results.py results.csv all-tests.txt"
    - "kill $(fuser 80/tcp 2>/dev/null) || true"
    - "if ip addr show dev br100; then"
    - "    ip addr del dev br100 192.168.1.1/24"
    - "fi"
    - "set +x"


params:
  LAVA_RUN_TEMPEST: 'yes'
  LAVA_TESTS_TO_RUN: ''

parse:
  pattern: "TEST@(?P<test_case_id>[-0-9A-Za-z_.]+)@ RESULT@(?P<result>[-0-9A-Za-z_.]+)@"
